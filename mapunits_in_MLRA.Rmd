---
title: "mapunits_in_MLRA"
author: "Nathan Roe"
date: "2/22/2022"
output: html_document
---

This file is used to determine what mapunits are in an MLRA. The relationship between
map unit and MLRA has been developed by Dylan Beaudette. Determining the mapunits in an MLRA
is a necessary step in the 'EDIT ecosite data' workflow.

This file considers a mapunit to be part of an MLRA if greater than 15% of its total area is within
an MLRA. This threshold can be adjusted on line 41. 

Note: The relationships between map unit and MLRA are determined using map unit boundaries and 
MLRA boundaries. These data sources use different spatial scales. Therefore, there is some fuzziness 
in calculations of membership. Refer to https://github.com/ncss-tech/SoilWeb-data and dylan.beaudette@usda.gov for details. 

Necessary changes: You will need enter your MLRA of interest on line 43. 

library
```{r, message=FALSE, warning=FALSE}
library(sf)
library(dplyr)
library(RCurl)
library(data.table)
```

Access the mukey, mlra relationships that Dylan Beaudette has developed
```{r}
url <- "https://github.com/ncss-tech/SoilWeb-data/raw/main/files/mukey-mlra-overlap.csv.gz"

tmp <- tempfile()

download.file(url, tmp)

mu_mlra_assignment <- read.csv(tmp,
                 stringsAsFactors = FALSE)
```

Reduce to MLRA of interest. I am interested in MLRA 18. Change the 18 below to define your MLRA of interest. This is case sensitive, so if your MLRA is 22A, enter "22A" not "22a". 
```{r}
mu_mlra_reduced <- mu_mlra_assignment %>% filter(mlra == "15") %>% filter(membership > 0.15)
```

More than 2100 mapunits?
```{r}
nrow(mu_mlra_reduced) > 2100
```

If FALSE, then you have 2100 or less mapunits in your MLRA. That makes things easy because NASIS queries/reports work well with 2100 or less mapunits. 

If TRUE, you have more than 2100 mapunits in your MLRA. Some NASIS queries/reports will not run with more than 2100 mapunits. Therefore, this script will split the mapunits up into two lists. 

If you have 2100 mapunits or less, they will be listed below:
```{r}
if(length(mu_mlra_reduced$mukey) <= 2100){
  paste(mu_mlra_reduced$mukey, collapse = ", ")} else{print("More than 2100 mapunits. The list will need to be split into two parts to be compatible with many NASIS reports.")}
```

If you have more than 2100 mapunits, the first 1-2100 will be listed here:
```{r}
if(length(mu_mlra_reduced$mukey) > 2100){
  paste(mu_mlra_reduced$mukey[1:2100], collapse = ", ")}else{print("There are 2100 or fewer mapunits. The full list is above.")}
```

If you have more than 2100 mapunits, any mapunits remaining beyond the first 2100 will be listed here:
```{r}
if(length(mu_mlra_reduced$mukey) > 2100){
  paste(mu_mlra_reduced$mukey[2100:length(mu_mlra_reduced)], collapse = ", ")}else{print("There are 2100 or fewer mapunits. The full list is above.")}
```

You will either have one or two comma separated list of mapunits depending on the number of mapunits in your MLRA. Select and copy your comma separated list excluding the outer quotation marks. For example 463903, 2924960, 2218095, 2924975, 462063, 462481, 2924970. This will be pasted into the NASIS report as described in the read_me.doc file if your are following 'EDIT ecosite data' workflow. 

If you have more than 2100 mapunits, you will have to run the NASIS report on the two groups individually. Once you have run the first group and copy/pasted the results into an Excel speadsheet, run the second group and paste the results into the same Excel spreadsheet below the first results. Now you will have both groups compiled into one spreadsheet and you can continue with the workflow. 

Consider saving this html output for easy access to a list of map units in your MLRA. To do so, click 'Open in Browser' at the top of this window, then right click and save. 


